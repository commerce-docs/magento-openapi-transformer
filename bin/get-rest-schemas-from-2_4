#!/bin/bash
set -e

#############################
# This script gets REST shemas for guest, admin, and customer from a running local Magento instance (http://127.0.0.1/)
# 
# Use Google Authenticator to pass two-factor authentication.
# Mail service to succeed with 2FA registration: http://127.0.0.1:8025
# 
# Admin credentials:
#     admin
#     123123q
##############################

mkdir -p __output__

############################
# Get REST schema as Guest #
############################

# Send a GET request and write schema to a file
curl http://127.0.0.1/rest/default/schema > __output__/guest-schema-original.json

############################
# Get REST schema as Admin #
############################

# Get OTP
read -p 'Enter code from the Google Authenticator app: ' OTP

# Get Admin token
ADMIN_TOKEN=$(curl --data "{\"username\": \"admin\", \"password\": \"123123q\", \"otp\":\"${OTP}\"}" --header 'Content-Type: application/json' http://127.0.0.1/rest/default/V1/tfa/provider/google/authenticate)

# Send a GET request and write schema to a file. Remove double quotes in ADMIN_TOKEN.
curl --header "Authorization: Bearer ${ADMIN_TOKEN//\"}" http://127.0.0.1/rest/default/schema > __output__/admin-schema-original.json

###############################
# Get REST schema as Customer #
###############################

# Create a customer
curl --request POST --data @scipts/customer.json --header 'Content-Type: application/json' http://127.0.0.1/rest/default/V1/customers

# Get the customer's token
CUSTOMER_TOKEN=$(curl --data '{"username": "jdoe@example.com", "password": "Password1"}' --header 'Content-Type: application/json' http://127.0.0.1/rest/default/V1/integration/customer/token)

# Send a GET request and write schema to a file. Remove double quotes in CUSTOMER_TOKEN.
curl --header "Authorization: Bearer ${CUSTOMER_TOKEN//\"}" http://127.0.0.1/rest/default/schema > __output__/customer-schema-original.json

# # Check exceptions
# cat /var/www/html/magento2/var/log/exception.log

yarn install

yarn start -i .__output__/guest-schema-original.json -o __output__/guest-schema-transformed.json

yarn start -i __output__/admin-schema-original.json -o __output__/admin-schema-transformed.json

yarn start -i __output__/customer-schema-original.json -o __output__/customer-schema-transformed.json
